http {

    map $http_client_type $web_limit_key {
        default $binary_remote_addr;
        "mobile" "";
    }

    map $http_client_type $mobile_limit_key {
        default "";
        "mobile" $binary_remote_addr;
    }

    limit_req_zone $web_limit_key zone=web:10m rate=50r/s;
    limit_req_zone $mobile_limit_key zone=mobile:10m rate=30r/s;

    upstream backend {
        server localhost:8081;
    }

    upstream logistics_backend {
        server localhost:9090 max_fails=5 fail_timeout=30s;
    }

    server {
        listen 8080;

        location /api/ {
            limit_req zone=web burst=100 nodelay;
            limit_req zone=mobile burst=60 nodelay;
            proxy_pass http://backend;
        }
    }

    server {
        listen 8081;

        location /api/ {
            add_header Content-Type application/json;

            if ($http_client_type = "web") {
                return 200 '{"status": "success", "service": "web_backend", "data": "Web application response"}';
            }
            if ($http_client_type = "mobile") {
                return 200 '{"status": "success", "service": "mobile_backend", "data": "Mobile application response"}';
            }

            return 200 '{"status": "success", "service": "default_backend", "data": "Default response"}';
        }
    }

    server {
        listen 9090;

        location / {
            add_header Content-Type application/json;

            if ($arg_type = "fast") {
                return 200 '{"status": "success", "service": "logistics", "response_time": "fast", "tracking_id": "TRK_FAST_123"}';
            }

            if ($arg_type = "slow") {
                return 200 '{"status": "slow", "service": "logistics", "response_time": "5000ms", "message": "This response is delayed"}';
            }

            if ($arg_type = "error") {
                return 500 '{"status": "error", "service": "logistics", "error_code": "INTERNAL_ERROR", "message": "Service temporarily unavailable"}';
            }

            if ($arg_type = "random") {
                return 200 '{"status": "success", "service": "logistics", "type": "random", "note": "Random behavior simulation"}';
            }

            return 200 '{"status": "success", "service": "logistics", "data": {"tracking_id": "TRK123456", "estimated_delivery": "2024-01-15", "status": "in_transit"}}';
        }

        location /fast {
            add_header Content-Type application/json;
            return 200 '{"status": "success", "endpoint": "fast", "message": "Quick response"}';
        }

        location /slow {
            add_header Content-Type application/json;
            return 200 '{"status": "slow", "endpoint": "slow", "message": "This is a deliberately slow response", "delay": "5000ms"}';
        }

        location /error {
            add_header Content-Type application/json;
            return 503 '{"status": "error", "endpoint": "error", "error": "service_unavailable", "message": "Logistics service is experiencing issues"}';
        }

        location /unavailable {
            add_header Content-Type application/json;
            return 500 '{"status": "error", "endpoint": "unavailable", "error": "internal_server_error"}';
        }

        location /random-behavior {
            add_header Content-Type application/json;
            set $last_digit 0;
            if ($remote_addr ~* ".*\.(\d)$") {
                set $last_digit $1;
            }

            if ($last_digit ~* "[13579]") {
                return 200 '{"status": "success", "service": "logistics", "type": "random_success", "ip_last_digit": "$last_digit"}';
            }
            if ($last_digit ~* "[24680]") {
                return 503 '{"status": "error", "service": "logistics", "type": "random_error", "ip_last_digit": "$last_digit"}';
            }

            return 200 '{"status": "success", "service": "logistics", "type": "default"}';
        }
    }
}
