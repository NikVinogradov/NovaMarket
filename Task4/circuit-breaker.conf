http {
    upstream backend {
        server localhost:8081;
    }

    upstream logistics_backend {
        server localhost:9090 max_fails=5 fail_timeout=30s;
    }

    server {
        listen 8080;

        location /logistics/ {
            rewrite ^/logistics/(.*)$ /$1 break;
            proxy_pass http://logistics_backend;
            proxy_connect_timeout 3s;
            proxy_read_timeout 3s;
            proxy_send_timeout 3s;
            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
            proxy_intercept_errors on;
            error_page 500 502 503 504 = /logistics-fallback;
        }

        location = /logistics-fallback {
            add_header Content-Type application/json;
            return 503 '{"status": "fallback", "message": "Logistics service temporarily unavailable"}';
        }
    }

    server {
        listen 8081;

        location /api/ {
            add_header Content-Type application/json;

            if ($http_client_type = "web") {
                return 200 '{"status": "success", "service": "web_backend", "data": "Web application response"}';
            }
            if ($http_client_type = "mobile") {
                return 200 '{"status": "success", "service": "mobile_backend", "data": "Mobile application response"}';
            }

            return 200 '{"status": "success", "service": "default_backend", "data": "Default response"}';
        }
    }

    server {
        listen 9090;

        location / {
            add_header Content-Type application/json;

            if ($arg_type = "fast") {
                return 200 '{"status": "success", "service": "logistics", "response_time": "fast", "tracking_id": "TRK_FAST_123"}';
            }

            if ($arg_type = "slow") {
                return 200 '{"status": "slow", "service": "logistics", "response_time": "5000ms", "message": "This response is delayed"}';
            }

            if ($arg_type = "error") {
                return 500 '{"status": "error", "service": "logistics", "error_code": "INTERNAL_ERROR", "message": "Service temporarily unavailable"}';
            }

            if ($arg_type = "random") {
                return 200 '{"status": "success", "service": "logistics", "type": "random", "note": "Random behavior simulation"}';
            }

            return 200 '{"status": "success", "service": "logistics", "data": {"tracking_id": "TRK123456", "estimated_delivery": "2024-01-15", "status": "in_transit"}}';
        }

        location /fast {
            add_header Content-Type application/json;
            return 200 '{"status": "success", "endpoint": "fast", "message": "Quick response"}';
        }

        location /slow {
            add_header Content-Type application/json;
            return 200 '{"status": "slow", "endpoint": "slow", "message": "This is a deliberately slow response", "delay": "5000ms"}';
        }

        location /error {
            add_header Content-Type application/json;
            return 503 '{"status": "error", "endpoint": "error", "error": "service_unavailable", "message": "Logistics service is experiencing issues"}';
        }

        location /unavailable {
            add_header Content-Type application/json;
            return 500 '{"status": "error", "endpoint": "unavailable", "error": "internal_server_error"}';
        }

        location /random-behavior {
            add_header Content-Type application/json;
            set $last_digit 0;
            if ($remote_addr ~* ".*\.(\d)$") {
                set $last_digit $1;
            }

            if ($last_digit ~* "[13579]") {
                return 200 '{"status": "success", "service": "logistics", "type": "random_success", "ip_last_digit": "$last_digit"}';
            }
            if ($last_digit ~* "[24680]") {
                return 503 '{"status": "error", "service": "logistics", "type": "random_error", "ip_last_digit": "$last_digit"}';
            }

            return 200 '{"status": "success", "service": "logistics", "type": "default"}';
        }
    }
}
